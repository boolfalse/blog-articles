
## event-loopึีจ ีบึีกีฏีฟีซีฏ ึึีซีถีกีฏีถีฅึีธีพึ ิธีถีคีฐีกีถีธึึ ีบีกีฟีฏีฅึ (ีดีกีฝ 6/7)

### NGNTJS - ีดีกีฝ 6

---

NGNTJS ีฐีธีคีพีกีฎีกีทีกึีซ ีถีกีญีธึีค [ีดีกีฝ 5](https://medium.com/@boolfalse/thread-pool-%D5%A1%D5%B6%D5%A1%D5%AC%D5%B8%D5%A3-%D5%BC%D5%A5%D5%A1%D5%AC-%D5%AF%D5%B5%D5%A1%D5%B6%D6%84%D5%AB%D6%81-8fb6f5f4bfd7)ึีธึีด ีฎีกีถีธีฉีกึีฅีฌ ีฅีถึ thread pool ีฃีกีฒีกึีกึีซ ีฐีฅีฟ, ึ ีคึีก ีฃีธึีฎีถีกีฏีกีถ ึึีซีถีกีฏีจ ีบึีธีตีฅีฏีฟีฅีฌ ีฅีถึ ีผีฅีกีฌ ีฏีตีกีถึีซึ ีพีฅึึีพีกีฎ ีคีฅีบึีซ ีพึีกึ
ิฑีตีฝ ีดีกีฝีธึีด ีฏีคีซีฟีกึีฏีฅีถึ ีฟีกึีขีฅึ ึึีซีถีกีฏีถีฅึ (ึีกีตีฌ ีกีผ ึีกีตีฌ), ึ ีกีตีค ึึีซีถีกีฏีถีฅึีซ ีดีซีปีธึีธีพ ีฏึีธึีฑีฅีถึ ีฐีกีฝีฏีกีถีกีฌ ีฉีฅ ีซีถีนีบีฅีฝ ีง ีกีทีญีกีฟีธึีด event-loopึีจ ีฃีธึีฎีถีกีฏีกีถีธึีดึ

<img src="https://i.imgur.com/Cr2NSPb.png" style="width:100%;">
 
[ีีฏีกึีจี [unsplash.com](https://unsplash.com/photos/UEX8WkrdQgE)]

ีีซีถีน ีกีตีฝ ีฐีธีคีพีกีฎีถีฅึีซ ีทีกึึีจ ึ ีฐีกีฟีฏีกีบีฅีฝ ีกีตีฝ ีดีกีฝีจ ีบีกีฟึีกีฝีฟีฅีฌีจ ีธึีฝีธึีดีถีกีฝีซึีพีฅีฌ ีฅีถ ีขีกีฆีธึีด ีถีตีธึีฉีฅึ, ีธึีฟีฅีฒ ีฐีซีดีถีกีฏีกีถีธึีด ีถีฏีกีฟีพีธึีด ีง ีฐีฅีฟึีตีกีฌ ีฟึีกีดีกีขีกีถีกีฏีกีถ ีฐีกีปีธึีคีกีฏีกีถีธึีฉีตีธึีถีจี ีฝีฏีฆีขีธึีด ีฝีกีฐีดีกีถีพีธึีด ีง ีฉีฅ ีซีถีน ีง event-loopึีจ, ีกีตีถีธึีฐีฅีฟึี ีซีถีนีบีฅีฝ ีง ีกีตีถ ีกีทีญีกีฟีธึีดึ
ิปีฐีกึีฏีฅ ีกีตีฝีฟีฅีฒ ึีฝ ีดีซีกีถีฃีกีดีซึ ีกีถึีธึีด ีนีฏีก (ีถีกีญีธึีคี [ีดีกีฝ 5](https://medium.com/@boolfalse/thread-pool-%D5%A1%D5%B6%D5%A1%D5%AC%D5%B8%D5%A3-%D5%BC%D5%A5%D5%A1%D5%AC-%D5%AF%D5%B5%D5%A1%D5%B6%D6%84%D5%AB%D6%81-8fb6f5f4bfd7)ึีธึีด ึ [ีดีกีฝ 4](https://medium.com/@boolfalse/libuv-event-loop-%D5%AE%D5%A1%D5%B6%D5%B8%D5%A9%D5%B8%D6%82%D5%A9%D5%B5%D5%B8%D6%82%D5%B6-886772ab3df)ึีธึีด ีฏีก ีธึีธีทีกีฏีซ ีฎีกีถีธีฉีธึีฉีตีธึีถ libUVึีซ ึ event-loopึีซ ีฐีฅีฟ ีฏีกีบีพีกีฎ), ีขีกีตึ ีธึีบีฅีฝ ีฐีฅีฒีซีถีกีฏี ีฏีกึีฎีธึีด ีฅีด ีธึ ีฟีพีตีกีฌ ีคีฅีบึีธึีด ีกึีชีซ ีฝีฏีฝีฅีฌ event-loopึีซ ีธึีฝีธึีดีถีกีฝีซึีธึีฉีตีธึีถีจ ีฃีธึีฎีถีกีฏีกีถ ึึีซีถีกีฏีถีฅึีธีพ (ีฐีกีฝีฏีกีถีกีฌีธีพ ีฉีฅ ีซีถีนีบีฅีฝ ีง ีกีตีถ ีกีทีญีกีฟีธึีด), ีกีตีถีธึีฐีฅีฟึ ีกีพีฅีฌีซ ีดีฅีฎ ีบีกีฟีฏีฅึีธีพ ีฏีฐีกีฝีฏีกีถีกีถึ ีฉีฅ ีซีถีน ีง ีกีตีถ ีซึีกีฏีกีถีธึีด:

ีึีซีถีกีฏ 1โค microtask and timer queues

```javascript
setTimeout(() => console.log("setTimeout 1"), 0);
setTimeout(() => {
  console.log("setTimeout 2");
  process.nextTick(() => console.log("setTimeout 2 nextTick"))
}, 0);
setTimeout(() => console.log("setTimeout 3"), 0);

process.nextTick(() => console.log("nextTick 1"));
process.nextTick(() => {
  console.log("nextTick 2");
  process.nextTick(() => console.log("nextTick 2 nextTick"));
});
process.nextTick(() => console.log("nextTick 3"));

Promise.resolve().then(() => console.log("Promise 1"));
Promise.resolve().then(() => {
  console.log("Promise 2");
  process.nextTick(() => console.log("Promise 2 nextTick"));
});
Promise.resolve().then(() => console.log("Promise 3"));
```

ิฑึีคีตีธึีถึีจ ีฏีฌีซีถีซ ีฐีฅีฟึีตีกีฌีจี

```log
nextTick 1
nextTick 2
nextTick 3
nextTick 2 nextTick
Promise 1
Promise 2
Promise 3
Promise 2 nextTick
setTimeout 1
setTimeout 2
setTimeout 3
setTimeout 2 nextTick
```

ีึีซีถีกีฏ 2โค I/O queue and timer queue anomaly

```javascript
const fs = require("fs");

setTimeout(() => console.log("setTimeout"), 0);
fs.readFile(__filename, () => console.log("readFile"));
// for (let i = 0; i < 1000000000; i++) {}
```

ิฑึีคีตีธึีถึีจ ีฏีฌีซีถีซ ีฐีฅีฟึีตีกีฌีจี

```log
setTimeout
readFile
// ีกีถีธีดีกีฌีซีก
readFile
setTimeout
```

ีึีซีถีกีฏ 3โค I/O queue and I/O polling

```javascript
const fs = require("fs");

fs.readFile(__filename, () => {
  console.log("readFile");
});
process.nextTick(() => console.log("nextTick"));
Promise.resolve().then(() => console.log("Promise"));
setTimeout(() => console.log("setTimeout"), 0);
setImmediate(() => console.log("setImmediate"));

for (let i = 0; i < 1000000000; i++) {}
```

ิฑึีคีตีธึีถึีจ ีฏีฌีซีถีซ ีฐีฅีฟึีตีกีฌีจี

```log
nextTick
Promise
setTimeout
setImmediate
readFile
```

ีึีซีถีกีฏ 4โค check queue & timer queue anomaly

```javascript
setTimeout(() => console.log("setTimeout"));
setImmediate(() => console.log("setImmediate"));
```

ิฑึีคีตีธึีถึีจ ีฏีฌีซีถีซ ีฐีฅีฟึีตีกีฌีจี

```log
setTimeout
setImmediate
// ีกีถีธีดีกีฌีซีก
setImmediate
setTimeout
```

ีึีซีถีกีฏ 5โค Close queue in the end

```javascript
const fs = require("fs");

const readableStream = fs.createReadStream(__filename);
readableStream.on("close", () => {
  console.log("readableStream");
});
readableStream.close();

setImmediate(() => console.log("setImmediate"));
setTimeout(() => console.log("setTimeout"), 0);
Promise.resolve().then(() => console.log("Promise"));
process.nextTick(() => console.log("nextTick"));
```

ิฑึีคีตีธึีถึีจ ีฏีฌีซีถีซ ีฐีฅีฟึีตีกีฌีจี

```log
nextTick
Promise
setTimeout
setImmediate
readableStream
```

ีึีซีถีกีฏีถีฅึีจ ีฏีกึีธีฒ ีฅึ ีฃีฟีถีฅีฌ ีถีกึ [GitHub Gist](https://gist.github.com/boolfalse/5f2c7160a6478da492634facc0c416e9)ึีธึีดึ

ิฑีตีฝ ึึีซีถีกีฏีถีฅึีธึีด ีฐีฅึีฉีธีพ ีกีถึีธึีด ีง ีฏีกีฟีกึีพีธึีด microtask (nextTick ึ Promise), timer, I/O (I/O polling), check, close queueึีถีฅึีธีพึ

ิฑีตีชีด ึีกีถีซ ีธึ ีกีตีฝีฟีฅีฒ ีกึีคีฅีถ ีฐีกีฝีฏีกีถีธึีด ีฅีถึี ีซีถีน ีง ีซึีฅีถีซึ ีถีฅึีฏีกีตีกึีถีธึีด event-loop ีดีฅีญีกีถีซีฆีดีจ, ึ ีฃีซีฟีฅีถึ ีกีทีญีกีฟีกีถึีซ ึีธึีฌีฅึีจ, ีฏีกึีฅีฌีซ ีง ีถีกีตีฅีฌ Node.js ีณีกึีฟีกึีกีบีฅีฟีธึีฉีตีกีถีจ "ีดีฅีฎ" ีบีกีฟีฏีฅึีธีพึ
ีีกีถึีธึีด "Node.js architecture" ีขีกีถีกีฌีซึีขีกีผีจ ีฏีซึีกีผีฅีฌีธีพ ีฏีกึีฅีฌีซ ีง ีฃีฟีถีฅีฌ ีขีกีฆีดีกีฉีซีพ ีพีซีฆีธึีกีฌีถีฅึ, ีธึีธีถึ ีฏีกีฆีดีพีกีฎ ีฅีถ ีฟีกึีขีฅึ ีฐีฅีฒีซีถีกีฏีถีฅึีซ ีฏีธีฒีดีซึ ีจีฝีฟ ีธึีธีท ีบีกีฐีกีถีปีถีฅึีซี ีถีฅึีฏีกีตีกึีถีฅีฌีธึ ีซึีฅีถึ ีธึีฆีกีฎ ีกีตีฝ ีฏีกีด ีกีตีถ ีขีกีฒีกีคึีซีนีจ ีฏีกีด ีกีทีญีกีฟีกีถึีซ ีขีถีธึีตีฉีจึ
ีีฟีธึึ ีฏีฟีฅีฒีกีคึีฅีด ีซีด ีฏีธีฒีดีซึ ีบีกีฟึีกีฝีฟีพีกีฎ ีพีซีฆีธึีกีฌีจ, ีธึีฟีฅีฒ ีถีฅึีฏีกีตีกึีพีกีฎ ีฅีถ ีธึีธีท ีฏีฟีธึีถีฅึ, ีธึีธีถึ ึีธีญีกีฆีคีฅึีธึีฉีตีธึีถีถีฅึีธีพ ีบีกีตีดีกีถีกีพีธึีพีกีฎ ีง ีกีทีญีกีฟีกีถึีจ Node.js Runtimeึีธึีดึ ิฑีตีถ ีดีกีฏีฅึีฅีฝีกีตีซีถ ีง, ึ ีฉีฅึึีฝ ีดีซีฟีพีกีฎ ีง ีกีพีฅีฌีซ ีฟึีกีดีกีขีกีถีกีฏีกีถ ีทีฒีฉีกีตีซีถ, ึีกีถ ีฉีฅ ีกีผีกีถีฑีซีถ ีฎึีกีฃึีกีตีซีถ ีขีฌีธีฏีถีฅึีซีถึ

<img src="https://i.imgur.com/sHsjTvh.png" style="width:100%;">
 
[libUVึีซ event-loop ึ ีดีตีธึีฝ ีฏีธีดีบีธีถีธีถีฟีถีฅึีซ ึีธีญีกีฆีคีฅึีธึีฉีตีธึีถีจ Node.js runtimeึีธึีด]

ีีกีฏีซึีณ ีถีฅึีฏีกีตีกึีถีฅีถึ ีพีซีฆีธึีกีฌีธึีด ีถีทีพีกีฎ ีถีธึ (ีฐีธีคีพีกีฎีถีฅึีซ ีทีกึึีธึีด ีคีฅีผึีฝ ีนีดีฅีฏีถีกีขีกีถีพีกีฎ) ีฟีฅึีดีซีถีถีฅึีซ ีถีทีกีถีกีฏีธึีฉีตีธึีถีจโค

- **event-demultiplexer** - ีบีกีฟีกีฝีญีกีถีกีฟีธึ ีง ีฟีกึีขีฅึ I/O ีกีฒีขีตีธึึีถีฅึีซ ีดีธีถีซีฟีธึีซีถีฃีซ ึ event-ีถีฅึีจ ีจีถีคีธึีถีฅีฌีธึ ีฐีกีดีกึ: ิตีฉีฅ I/O ีกีฒีขีตีธึึีจ ีบีกีฐีกีถีปีธึีด ีง blocking operation, ีกีบีก event-DEMUX-ีจ ีฟีพีตีกีฌ taskึีจ ีฏึีธีญีกีถึีซ ีคีฅีบีซ C/C++ ีคีกีทีฟ, ีธึีฟีฅีฒ ีฏีฏีกีฟีกึีพีซ ีฟีพีตีกีฌ taskึีจึ Taskึีจ ีกีพีกึีฟีพีฅีฌีธึีถ ีบีฅีฝ, C/C++ ีฏีธีฒีดีจ ีฏีฟีฅีฒีฅีฏีกึีถีซ event-dispatcherึีซีถ, ีธึีถ ีซึ ีฐีฅึีฉีซีถ ีกีตีถ ีฏีธึีฒีกึีฏีซ ีคีฅีบีซ event-loopึีซ ีฏีธีถีฏึีฅีฟ queueึีธึีด ีกีพีฅีฌีกึีถีฅีฌีธึ:
- **event-dispatcher** - ีบีกีฟีกีฝีญีกีถีกีฟีธึ ีง eventึีถีฅึีซ ีฒีฅีฏีกีพีกึีดีกีถี ีฝีฟีกึีดีกีถึีธึีฒีกึีฏีดีกีถ ีฐีกีดีกึึ
- **kqueue** - BSD-based ีดีฅีญีกีถีซีฆีด event notificationึีถีฅึีซ ีฐีกีดีกึ (macOS, FreeBSD, NetBSD)
- **IOCP** (input/output completion ports) - Windows OS ีจีถีฟีกีถีซึีซ ีดีฅีญีกีถีซีฆีด event notificationึีถีฅึีซ ีฐีกีดีกึ
- **event ports** - Solaris-specific ีดีฅีญีกีถีซีฆีด event notificationึีถีฅึีซ ีฐีกีดีกึ (Oracle Solaris, OpenSolaris)
- **epoll** - Linux-specific ีดีฅีญีกีถีซีฆีด event notificationึีถีฅึีซ ีฐีกีดีกึ

ีึีบีฅีฝ ีฐีกีพีฅีฌีธึีด, ีฏีกึีฅีฌีซ ีถีทีฅีฌ ีถีกึ, ีธึ ีพีฅึีธีฃึีตีกีฌีซึ ีขีกึีซ libUVึีถ ีฟึีกีดีกีคึีธึีด ีง ึีฃีฟีกีฃีธึีฎีดีกีถ ีฐีกีดีกึ ีกีตีฌ ีฏีกึึีธึ featureึีถีฅึ ีถีธึีตีฝีบีฅีฝโค

- **Asynchronous I/O** - libUV-ีถ ีกีบีกีฐีธีพีธึีด ีง ีจีถีคีฐีกีถีธึึ ีซีถีฟีฅึึีฅีตีฝ ีฟีกึีขีฅึ OSึีถีฅึีธึีด ีกีฝีซีถีญึีธีถ I/O ีฃีธึีฎีกีผีถีธึีฉีตีธึีถีถีฅึีซ ีฐีกีดีกึ:
- **Signal handling** - libUV-ีถ ีฟึีกีดีกีคึีธึีด ีง APIโค OS signalึีถีฅึีซ ีฒีฅีฏีกีพีกึีดีกีถ ีฐีกีดีกึ ีฃึีกีถึีพีธึีด ีฅีถ signal handlerึีถีฅึ, ีซีถีนีบีซีฝีซึ ีฅีถ SIGINT-ีจ ีฏีกีด SIGTERM-ีจ:
- **File system operations** - libUV-ีถ ีฟึีกีดีกีคึีธึีด ีง APIโค ึีกีตีฌีกีตีซีถ ีฐีกีดีกีฏีกึีฃีซ ีฃีธึีฎีธีฒีธึีฉีตีธึีถีถีฅึ ีฏีกีฟีกึีฅีฌีธึ ีฐีกีดีกึ, ีซีถีนีบีซีฝีซึ ีฅีถ file writingึีจ ีฏีกีด file readingึีจ:
- **Network I/O** - libUV-ีถ ีกีบีกีฐีธีพีธึีด ีง APIโค Network I/O operationึีถีฅึีจ ีฏีกีฟีกึีฅีฌีธึ ีฐีกีดีกึ, ีซีถีนีบีซีฝีซึ ีฅีถ TCP/UDP-socketึีถีฅึีซ ีฝีฟีฅีฒีฎีธึีดีถ ีธึ ีฏีกีผีกีพีกึีธึีดีจ:
- **Child processes management** - libUV-ีถ ีฟึีกีดีกีคึีธึีด ีง APIโค child_processึีถีฅึีซ ีฝีฟีฅีฒีฎีดีกีถ ึ ีฒีฅีฏีกีพีกึีดีกีถ ีฐีกีดีกึึ
- ...

ีีกีฝีถีฅีฌีธีพ ีกีตีฝ ีบีกีฐีซีถี ีฏีกึีธีฒ ีฅีถึ ีดีฅีปีขีฅึีฅีฌ Reactor Patternึีซ ีฃีกีฒีกึีกึีจ:

<img src="https://i.imgur.com/WytzyaP.png" style="width:100%;">
 
[ีีฏีกึีจี [Chernobyl](https://www.imdb.com/title/tt7366338/) ีดีซีถีซึีฝีฅึีซีกีตีซึ]

NGNTJS ีฐีธีคีพีกีฎีถีฅึีซ ีทีกึึีซ ีกีตีฝ ีดีกีฝีธึีด ีธึีฝีธึีดีถีกีฝีซึีฅึีซีถึ event-loop ีดีฅีญีกีถีซีฆีดีจ ีฃีธึีฎีถีกีฏีกีถ ึึีซีถีกีฏีถีฅึีซ ีดีซีปีธึีธีพ, ีฎีกีถีธีฉีกึีกีถึ Reactor Patternึีซ ีกีทีญีกีฟีกีถึีซ ีฐีฅีฟึ
ีีกีปีธึีคี [ีดีกีฝ 7](https://medium.com/@boolfalse/javascript-%D5%AC%D5%A5%D5%A6%D5%B8%D6%82-runtime-engine-%D5%B4%D5%AB%D5%BB%D5%A1%D5%BE%D5%A1%D5%B5%D6%80-node-js-%D5%B4%D6%80%D6%81%D5%A1%D5%AF%D5%AB%D6%81%D5%B6%D5%A5%D6%80-deno-bun-82cf3222e94b)ึีธึีด ีฏึีถีถีกึีฏีฅีถึ JavaScript ีฌีฅีฆีพีซ, engineึีซ, runtimeึีซ ึ environmentึีซ (ีดีซีปีกีพีกีตึ) ีดีกีฝีซีถึ ิฑีบีก ีฏีฎีกีถีธีฉีกีถีกีถึ ีชีกีดีกีถีกีฏีกีฏีซึ JavaScript runtime/environmentึีถีฅึีซีถ, ีซีถีนีบีซีฝีซึ ีฅีถ Denoึีถ ึ Bunึีจ, ึ ีธีน ีดีซีกีตีถึ

***

ิตีฉีฅ ีฐีกีพีกีถีฅึีซึ ีกีตีฝ ีถีตีธึีฉีจ, ีกีฆีกีฟ ีฏีกึีธีฒ ีฅึ ีฐีฅีฟึีฅีฌ ีซีถีฑ ีกีตีฝีฟีฅีฒึ ๐

ิบีกีดีกีถีกีฏีกีฏีซึ ีฟีกึีขีฅึ ีฟีฅีญีถีธีฌีธีฃีซีกีถีฅึีธีพ ีกีทีญีกีฟีธีฒ ีบึีธีตีฅีฏีฟีถีฅึ ีธึีฝีธึีดีถีกีฝีซึีฅีฌีธึ ีฐีกีดีกึ ีฏีกึีธีฒ ีฅึ ีฐีฅีฟึีฅีฌ ีซีด [GitHub](https://github.com/boolfalse) ีงีปีซีถ, ีธึีฟีฅีฒ ีฅีฝ ีกีฏีฟีซีพีธึีฅีถ ีฐีกีถึีกีตีถีกึีถีธึีด ีฅีด ีซีด ีฏีกีฟีกึีกีฎ ีกีทีญีกีฟีกีถึีซ ีฆีฃีกีฌีซ ีดีกีฝีจึ

ิฑีตีฌ ีซีถึีธีซ ีฐีกีดีกึ ีฏีกึีธีฒ ีฅึ ีกีตึีฅีฌีฅีฌ ีซีด ึึีซึีซีกีฌ ีฏีกีตึ` [https://boolfalse.com/](https://boolfalse.com/)
